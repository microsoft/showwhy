name: Helm CI
on:
  push:
    branches: [azure]
  pull_request:
    paths:
      - 'config/**/*'
      - .github/workflows/ci-helm.yml
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: HelmInstaller@0
        displayName: "Install Helm 3.9.0"
        inputs:
          helmVersion: 3.9.0
          
      - name: login to ghcr using helm
        shell: bash    
        env:
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          echo ${{env.GITHUB_TOKEN}} | helm registry login ghcr.io --username ${{ github.repository_owner }} --password-stdin

      - name: Helm Chart
        env:
          GCR_IMAGE: ghcr.io/microsoft/showwhy-helm
          CHART_PATH: config/helm/causal-services
        run : |
          echo ${{env.GITHUB_TOKEN}} | helm registry login ghcr.io --username ${{ github.repository_owner }} --password-stdin
          export CHART_VERSION=$(grep 'version:' ${{ env.CHART_PATH }} | tail -n1 | awk '{ print $2}')
          helm package ${{ env.CHART_PATH }} --version ${CHART_VERSION}
          echo pushing $(basename ${{ env.CHART_PATH }})-${CHART_VERSION}.tgz to oci://$GCR_IMAGE
          helm push $(basename ${{ env.CHART_PATH }})-${CHART_VERSION}.tgz oci://$GCR_IMAGE
        shell: bash